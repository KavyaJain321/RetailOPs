<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetailOps - Order & Payment Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            min-height: 100vh;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .nav-link {
            color: #ecf0f1 !important;
            padding: 15px 25px;
            margin: 5px 0;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background-color: rgba(255,255,255,0.1);
            color: white !important;
            transform: translateX(5px);
        }

        .main-content {
            padding: 30px;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .stat-card {
            background: linear-gradient(135deg, var(--secondary-color), #5dade2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning-color), #f7dc6f);
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success-color), #58d68d);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger-color), #ec7063);
        }

        .btn-custom {
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
        }

        .badge-status {
            font-size: 0.9em;
            padding: 8px 12px;
            border-radius: 20px;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .alert {
            border-radius: 10px;
            border: none;
        }

        .modal-content {
            border-radius: 15px;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .retailer-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid var(--secondary-color);
        }

        .order-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }
    </style>
</head>
<body>
    <div id="toastContainer" class="notification-toast"></div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 col-lg-2 sidebar">
                <div class="text-center mb-4">
                    <h4 class="text-white">
                        <i class="fas fa-store"></i> RetailOps
                    </h4>
                    <p class="text-light small">Shubham Trading Co.</p>
                </div>
                
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                    <a class="nav-link" href="#" data-section="orders">
                        <i class="fas fa-shopping-cart"></i> Orders
                    </a>
                    <a class="nav-link" href="#" data-section="payments">
                        <i class="fas fa-credit-card"></i> Payments
                    </a>
                    <a class="nav-link" href="#" data-section="retailers">
                        <i class="fas fa-users"></i> Retailers
                    </a>
                    <a class="nav-link" href="#" data-section="stock">
                        <i class="fas fa-boxes"></i> Stock Management
                    </a>
                    <a class="nav-link" href="#" data-section="reports">
                        <i class="fas fa-chart-bar"></i> Reports
                    </a>
                    <a class="nav-link" href="#" data-section="notifications">
                        <i class="fas fa-bell"></i> Notifications
                    </a>
                </nav>
            </div>

            <div class="col-md-9 col-lg-10 main-content">
                
                <div id="dashboard" class="page-section active">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Dashboard Overview</h2>
                        <div class="text-muted">
                            <i class="fas fa-calendar"></i> <span id="currentDate"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h3 id="totalOrders">0</h3>
                                        <p class="mb-0">Total Orders</p>
                                    </div>
                                    <i class="fas fa-shopping-cart fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card success">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h3 id="totalRevenue">₹0</h3>
                                        <p class="mb-0">Total Revenue</p>
                                    </div>
                                    <i class="fas fa-rupee-sign fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card warning">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h3 id="pendingPayments">₹0</h3>
                                        <p class="mb-0">Pending Payments</p>
                                    </div>
                                    <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card danger">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h3 id="lowStockItems">0</h3>
                                        <p class="mb-0">Low Stock Items</p>
                                    </div>
                                    <i class="fas fa-box-open fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Recent Orders</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentOrdersList"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Quick Actions</h5>
                                </div>
                                <div class="card-body">
                                    <button class="btn btn-primary btn-custom w-100 mb-2" onclick="showSection('orders')">
                                        <i class="fas fa-plus"></i> New Order
                                    </button>
                                    <button class="btn btn-success btn-custom w-100 mb-2" onclick="showSection('retailers')">
                                        <i class="fas fa-user-plus"></i> Add Retailer
                                    </button>
                                    <button class="btn btn-info btn-custom w-100" onclick="generateReport()">
                                        <i class="fas fa-download"></i> Generate Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="orders" class="page-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Order Management</h2>
                        <button class="btn btn-primary btn-custom" data-bs-toggle="modal" data-bs-target="#orderModal">
                            <i class="fas fa-plus"></i> New Order
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Retailer</th>
                                            <th>Date</th>
                                            <th>Total Amount</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ordersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="payments" class="page-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Payment Tracking</h2>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="paymentFilter">
                                <option value="all">All Payments</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                                <option value="overdue">Overdue</option>
                            </select>
                            <button class="btn btn-success btn-custom" onclick="sendPaymentReminders()">
                                <i class="fab fa-whatsapp"></i> Send Reminders
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Payment ID</th>
                                            <th>Order ID</th>
                                            <th>Retailer</th>
                                            <th>Amount</th>
                                            <th>Due Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="retailers" class="page-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Retailer Management</h2>
                        <button class="btn btn-primary btn-custom" data-bs-toggle="modal" data-bs-target="#retailerModal">
                            <i class="fas fa-user-plus"></i> Add Retailer
                        </button>
                    </div>

                    <div class="row" id="retailersList"></div>
                </div>

                <div id="stock" class="page-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Stock Management</h2>
                        <button class="btn btn-primary btn-custom" data-bs-toggle="modal" data-bs-target="#stockModal">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong id="lowStockAlert">0 items</strong> below minimum stock level
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Product Name</th>
                                            <th>SKU</th>
                                            <th>Current Stock</th>
                                            <th>Min. Stock</th>
                                            <th>Unit Price</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stockTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="reports" class="page-section">
                    <h2 class="mb-4">Reports & Analytics</h2>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Generate Reports</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Report Type</label>
                                        <select class="form-select" id="reportType">
                                            <option value="sales">Sales Report</option>
                                            <option value="payments">Payment Report</option>
                                            <option value="stock">Stock Report</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Period</label>
                                        <select class="form-select" id="reportPeriod">
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="quarterly">Quarterly</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Format</label>
                                        <select class="form-select" id="reportFormat">
                                            <option value="pdf">PDF</option>
                                            <option value="csv">CSV</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary btn-custom w-100" onclick="generateReport()">
                                        <i class="fas fa-download"></i> Generate & Download
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Quick Stats</h5>
                                </div>
                                <div class="card-body">
                                    <div id="reportStats"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="notifications" class="page-section">
                    <h2 class="mb-4">WhatsApp Notifications</h2>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Notification Templates</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Template Type</label>
                                        <select class="form-select" id="templateType">
                                            <option value="payment_reminder">Payment Reminder</option>
                                            <option value="order_confirmation">Order Confirmation</option>
                                            <option value="stock_alert">Stock Alert</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Message Template</label>
                                        <textarea class="form-control" id="messageTemplate" rows="4"></textarea>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary btn-custom" onclick="saveTemplate()">
                                            <i class="fas fa-save"></i> Save Template
                                        </button>
                                        <button class="btn btn-success btn-custom" onclick="testNotification()">
                                            <i class="fab fa-whatsapp"></i> Send Test
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Notification Log</h5>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="notificationLog"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="orderForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Retailer</label>
                                    <select class="form-select" id="orderRetailer" required>
                                        <option value="">Select Retailer</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Order Date</label>
                                    <input type="date" class="form-control" id="orderDate" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Order Items</label>
                            <div id="orderItems">
                                </div>
                            <button type="button" class="btn btn-secondary mt-2" onclick="addOrderItem()">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Payment Terms (Days)</label>
                                    <input type="number" class="form-control" id="paymentTerms" value="30" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Total Amount</label>
                                    <input type="number" class="form-control" id="orderTotal" readonly>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveOrder()">Save Order</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="retailerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add/Edit Retailer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="retailerForm">
                        <input type="hidden" id="retailerId">
                        <div class="mb-3">
                            <label class="form-label">Shop Name</label>
                            <input type="text" class="form-control" id="shopName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Owner Name</label>
                            <input type="text" class="form-control" id="ownerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone Number (for calls)</label>
                            <input type="tel" class="form-control" id="phoneNumber" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">WhatsApp Number (with country code, e.g., 91...)</label>
                            <input type="tel" class="form-control" id="whatsappNumber" placeholder="e.g., 919876543210" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" id="address" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Credit Limit (₹)</label>
                            <input type="number" class="form-control" id="creditLimit" step="0.01">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRetailer()">Save Retailer</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="stockModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add/Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="stockForm">
                        <input type="hidden" id="productId">
                        <div class="mb-3">
                            <label class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">SKU</label>
                            <input type="text" class="form-control" id="productSKU" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Current Stock</label>
                                    <input type="number" class="form-control" id="currentStock" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Minimum Stock</label>
                                    <input type="number" class="form-control" id="minStock" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Unit Price (₹)</label>
                            <input type="number" class="form-control" id="unitPrice" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-control" id="productCategory">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- FULL STACK IMPLEMENTATION (CLIENT-SIDE) ---
        
        // Global in-memory data store for the application
        let appData = {};
        const API_URL = '';

        // --- Core Data Functions ---
        const loadData = async () => {
            try {
                const response = await fetch(`${API_URL}/api/data`);
                if (!response.ok) throw new Error('Failed to load data from server.');
                appData = await response.json();
                console.log('Data loaded from server.');
            } catch (error) {
                console.error(error);
                showToast('Could not connect to the server.', 'danger');
            }
        };

        const saveData = async () => {
            try {
                const response = await fetch(`${API_URL}/api/data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appData)
                });
                if (!response.ok) throw new Error('Failed to save data to server.');
                console.log('Data saved to server.');
                return true;
            } catch (error) {
                console.error(error);
                showToast('Failed to save data. Check server connection.', 'danger');
                return false;
            }
        };
        
        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            initializeApp();
            updateAllViews();
            setCurrentDate();
        });

        // --- Bulk Update and Navigation ---
        function updateAllViews() {
            updateDashboard();
            loadOrdersTable();
            loadPaymentsTable();
            loadRetailersList();
            loadStockTable();
            loadReportStats();
            loadNotificationLog();
        }

        function initializeApp() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection(link.dataset.section);
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });
            document.getElementById('orderDate').valueAsDate = new Date();
            addOrderItem(); // Add one item row by default to the order modal
        }

        function showSection(sectionId) {
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (sectionId === 'orders') {
                loadRetailerOptions();
                loadProductOptions();
            }
        }

        // --- View Loading Functions ---
        // (These functions read from the global `appData` object to render the UI)

        function setCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-IN', options);
        }

        function updateDashboard() {
            document.getElementById('totalOrders').textContent = appData.orders.length;
            document.getElementById('totalRevenue').textContent = '₹' + appData.orders.reduce((sum, order) => sum + order.totalAmount, 0).toLocaleString('en-IN');
            const pendingAmount = appData.payments.filter(p => p.status === 'pending' || p.status === 'overdue').reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('pendingPayments').textContent = '₹' + pendingAmount.toLocaleString('en-IN');
            const lowStockCount = appData.products.filter(p => p.currentStock <= p.minStock).length;
            document.getElementById('lowStockItems').textContent = lowStockCount;
            loadRecentOrders();
        }

        function loadRecentOrders() {
            const recentOrders = [...appData.orders].slice(-5).reverse();
            const container = document.getElementById('recentOrdersList');
            container.innerHTML = recentOrders.map(order => `
                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <div><strong>Order #${order.id}</strong> - ${order.retailerName}<br><small class="text-muted">${formatDate(order.date)}</small></div>
                    <div class="text-end"><div>₹${order.totalAmount.toLocaleString('en-IN')}</div><span class="badge ${getStatusClass(order.status)}">${order.status}</span></div>
                </div>`).join('') || '<p class="text-muted text-center mt-3">No recent orders</p>';
        }

        function loadOrdersTable() {
            const tbody = document.getElementById('ordersTable');
            tbody.innerHTML = [...appData.orders].reverse().map(order => `
                <tr>
                    <td>#${order.id}</td><td>${order.retailerName}</td><td>${formatDate(order.date)}</td>
                    <td>₹${order.totalAmount.toLocaleString('en-IN')}</td><td><span class="badge ${getStatusClass(order.status)}">${order.status}</span></td>
                    <td><button class="btn btn-sm btn-outline-success" onclick="markOrderComplete(${order.id})"><i class="fas fa-check"></i></button></td>
                </tr>`).join('');
        }

        function loadPaymentsTable() {
            const tbody = document.getElementById('paymentsTable');
            const filter = document.getElementById('paymentFilter')?.value || 'all';
            let filteredPayments = (filter === 'all') ? appData.payments : appData.payments.filter(p => p.status === filter);
            tbody.innerHTML = [...filteredPayments].reverse().map(payment => `
                <tr>
                    <td>#${payment.id}</td><td>#${payment.orderId}</td><td>${payment.retailerName}</td>
                    <td>₹${payment.amount.toLocaleString('en-IN')}</td><td>${formatDate(payment.dueDate)}</td>
                    <td><span class="badge ${getStatusClass(payment.status)}">${payment.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-success" onclick="markPaymentComplete(${payment.id})"><i class="fas fa-check"></i></button>
                        <button class="btn btn-sm btn-outline-info" onclick="sendPaymentReminder(${payment.id})"><i class="fab fa-whatsapp"></i></button>
                    </td>
                </tr>`).join('');
            const filterSelect = document.getElementById('paymentFilter');
            filterSelect.removeEventListener('change', loadPaymentsTable);
            filterSelect.addEventListener('change', loadPaymentsTable);
        }

        function loadRetailersList() {
            const container = document.getElementById('retailersList');
            container.innerHTML = appData.retailers.map(retailer => {
                const retailerOrders = appData.orders.filter(o => o.retailerId === retailer.id);
                const totalOrders = retailerOrders.length;
                const totalAmount = retailerOrders.reduce((sum, order) => sum + order.totalAmount, 0);

                return `
                <div class="col-md-6 col-lg-4">
                    <div class="retailer-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5>${retailer.shopName}</h5>
                                <p class="text-muted mb-1">${retailer.ownerName}</p>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-phone"></i> ${retailer.phoneNumber} | <i class="fab fa-whatsapp"></i> ${retailer.whatsappNumber}
                                </p>
                                <p class="text-muted mb-2">${retailer.address}</p>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editRetailer(${retailer.id})">Edit</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteRetailer(${retailer.id})">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center">
                            <div class="col-4">
                                <strong>${totalOrders}</strong><br><small>Orders</small>
                            </div>
                            <div class="col-4">
                                <strong>₹${totalAmount.toLocaleString('en-IN')}</strong><br><small>Revenue</small>
                            </div>
                            <div class="col-4">
                                <strong>₹${(retailer.creditLimit || 0).toLocaleString('en-IN')}</strong><br><small>Credit Limit</small>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function loadStockTable() {
            const tbody = document.getElementById('stockTable');
            tbody.innerHTML = appData.products.map(product => {
                const isLowStock = product.currentStock <= product.minStock;
                return `
                    <tr class="${isLowStock ? 'table-warning' : ''}">
                        <td>${product.name}</td>
                        <td>${product.sku}</td>
                        <td><strong>${product.currentStock}</strong></td>
                        <td>${product.minStock}</td>
                        <td>₹${product.unitPrice.toFixed(2)}</td>
                        <td><span class="badge ${isLowStock ? 'bg-danger' : 'bg-success'}">${isLowStock ? 'Low Stock' : 'In Stock'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${product.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-info" onclick="addStock(${product.id})"><i class="fas fa-plus"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');

            const lowStockCount = appData.products.filter(p => p.currentStock <= p.minStock).length;
            document.getElementById('lowStockAlert').textContent = `${lowStockCount} items`;
        }

        function loadRetailerOptions() {
            const select = document.getElementById('orderRetailer');
            select.innerHTML = '<option value="">Select Retailer</option>' + 
                appData.retailers.map(r => `<option value="${r.id}">${r.shopName}</option>`).join('');
        }

        function loadProductOptions(selector = '.product-select') {
            const selects = document.querySelectorAll(selector);
            const options = '<option value="">Select Product</option>' + 
                appData.products.map(p => `<option value="${p.id}" data-price="${p.unitPrice}">${p.name} (Stock: ${p.currentStock})</option>`).join('');
            
            selects.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = options;
                select.value = currentVal;
                select.removeEventListener('change', updateProductPrice);
                select.addEventListener('change', updateProductPrice);
            });
        }
        
        function updateProductPrice(e) {
            const option = e.target.selectedOptions[0];
            const priceInput = e.target.closest('.order-item').querySelector('.price-input');
            if (option && option.dataset.price) {
                priceInput.value = option.dataset.price;
                calculateOrderTotal();
            }
        }

        function addOrderItem() {
            const container = document.getElementById('orderItems');
            const newItemHTML = `
                <div class="order-item">
                    <div class="row align-items-center">
                        <div class="col-md-5"><select class="form-select product-select" required></select></div>
                        <div class="col-md-2"><input type="number" class="form-control quantity-input" placeholder="Qty" min="1" required></div>
                        <div class="col-md-3"><input type="number" class="form-control price-input" placeholder="Price" step="0.01" readonly></div>
                        <div class="col-md-2"><button type="button" class="btn btn-danger w-100 remove-item"><i class="fas fa-trash"></i></button></div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newItemHTML);
            const newItem = container.lastElementChild;
            
            loadProductOptions(`#${container.id} .product-select:last-of-type`);
            
            newItem.querySelector('.remove-item').addEventListener('click', () => {
                newItem.remove();
                calculateOrderTotal();
            });
            newItem.querySelector('.quantity-input').addEventListener('input', calculateOrderTotal);
        }

        function calculateOrderTotal() {
            let total = 0;
            document.querySelectorAll('#orderItems .order-item').forEach(item => {
                const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(item.querySelector('.price-input').value) || 0;
                total += quantity * price;
            });
            document.getElementById('orderTotal').value = total.toFixed(2);
        }

        async function saveOrder() {
            // Logic to collect order items and create newOrder object... (same as before)
            const items = [], retailerId = parseInt(document.getElementById('orderRetailer').value);
            document.querySelectorAll('#orderItems .order-item').forEach(item => {
                const productSelect = item.querySelector('.product-select');
                const quantity = parseFloat(item.querySelector('.quantity-input').value);
                const product = appData.products.find(p => p.id === parseInt(productSelect.value));
                if (product && quantity > 0) {
                    if (quantity > product.currentStock) {
                        throw new Error(`Not enough stock for ${product.name}. Available: ${product.currentStock}, Ordered: ${quantity}`);
                    }
                    items.push({
                        productId: product.id,
                        productName: product.name,
                        quantity,
                        price: product.unitPrice
                    });
                }
            });

            if (items.length === 0 || !retailerId) {
                showToast('Please add at least one valid item to the order.', 'danger');
                return;
            }
            const retailer = appData.retailers.find(r => r.id === retailerId);
            const newOrder = {
                id: (appData.orders.reduce((max, o) => Math.max(max, o.id), 0)) + 1,
                retailerId,
                retailerName: retailer.shopName,
                date: document.getElementById('orderDate').value,
                items,
                totalAmount: parseFloat(document.getElementById('orderTotal').value),
                status: 'pending',
                paymentTerms: parseInt(document.getElementById('paymentTerms').value)
            };
            
            // Update local state
            items.forEach(item => { appData.products.find(p => p.id === item.productId).currentStock -= item.quantity; });
            appData.orders.push(newOrder);
            const dueDate = new Date(newOrder.date);
            dueDate.setDate(dueDate.getDate() + newOrder.paymentTerms);
            appData.payments.push({
                id: newOrder.id, orderId: newOrder.id, retailerId: newOrder.retailerId,
                retailerName: newOrder.retailerName, amount: newOrder.totalAmount,
                dueDate: dueDate.toISOString().split('T')[0], status: 'pending'
            });

            // Persist to server
            if (await saveData()) {
                bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
                updateAllViews();
                showToast('Order created successfully!', 'success');
                await sendOrderConfirmation(newOrder);
            }
        }

        async function saveRetailer() {
            const retailerId = document.getElementById('retailerId').value;
            const retailerData = {
                shopName: document.getElementById('shopName').value.trim(),
                ownerName: document.getElementById('ownerName').value.trim(),
                phoneNumber: document.getElementById('phoneNumber').value.trim(),
                whatsappNumber: document.getElementById('whatsappNumber').value.trim().replace(/\D/g,''), // Sanitize number
                address: document.getElementById('address').value.trim(),
                creditLimit: parseFloat(document.getElementById('creditLimit').value) || 0
            };

            if (!retailerData.shopName || !retailerData.whatsappNumber) {
                showToast('Shop Name and WhatsApp Number are required.', 'danger');
                return;
            }

            if (retailerId) {
                const index = appData.retailers.findIndex(r => r.id === parseInt(retailerId));
                appData.retailers[index] = { ...appData.retailers[index], ...retailerData };
            } else {
                retailerData.id = (appData.retailers.reduce((max, r) => Math.max(max, r.id), 0)) + 1;
                appData.retailers.push(retailerData);
            }

            if (await saveData()) {
                bootstrap.Modal.getInstance(document.getElementById('retailerModal')).hide();
                loadRetailersList();
                showToast('Retailer saved successfully!', 'success');
            }
        }

        async function saveProduct() {
            const productId = document.getElementById('productId').value;
            const productData = {
                name: document.getElementById('productName').value,
                sku: document.getElementById('productSKU').value,
                currentStock: parseInt(document.getElementById('currentStock').value),
                minStock: parseInt(document.getElementById('minStock').value),
                unitPrice: parseFloat(document.getElementById('unitPrice').value),
                category: document.getElementById('productCategory').value
            };

            if (productId) {
                const index = appData.products.findIndex(p => p.id === parseInt(productId));
                appData.products[index] = { ...appData.products[index], ...productData };
            } else {
                productData.id = (appData.products.reduce((max, p) => Math.max(max, p.id), 0)) + 1;
                appData.products.push(productData);
            }

            if (await saveData()) {
                bootstrap.Modal.getInstance(document.getElementById('stockModal')).hide();
                updateAllViews();
                showToast('Product saved successfully!', 'success');
            }
        }
        
        async function markOrderComplete(orderId) {
            const order = appData.orders.find(o => o.id === orderId);
            if (order && order.status !== 'completed') {
                order.status = 'completed';
                const payment = appData.payments.find(p => p.orderId === orderId);
                if (payment) payment.status = 'completed';
                if (await saveData()) {
                    updateAllViews();
                    showToast(`Order #${orderId} marked as completed!`, 'success');
                }
            }
        }
        
        async function markPaymentComplete(paymentId) {
             const payment = appData.payments.find(p => p.id === paymentId);
             if (payment && payment.status !== 'completed') {
                payment.status = 'completed';
                const order = appData.orders.find(o => o.id === payment.orderId);
                if (order) order.status = 'completed';
                if (await saveData()) {
                    updateAllViews();
                    showToast(`Payment for Order #${payment.orderId} marked complete!`, 'success');
                }
            }
        }

        // --- Notification Functions ---
        async function sendWhatsAppMessage(number, message) {
            try {
                const response = await fetch(`${API_URL}/api/whatsapp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ number, message })
                });
                if (!response.ok) throw new Error('Server failed to process the request.');
                const result = await response.json();
                console.log(result.message);
                return true;
            } catch (error) {
                console.error(error);
                showToast('Failed to send notification via server.', 'danger');
                return false;
            }
        }

        async function sendPaymentReminder(paymentId) {
            const payment = appData.payments.find(p => p.id === paymentId);
            const retailer = appData.retailers.find(r => r.id === payment.retailerId);
            if (payment && retailer) {
                const message = appData.templates.payment_reminder
                    .replace('{{retailer_name}}', retailer.ownerName)
                    .replace('{{amount}}', payment.amount.toLocaleString('en-IN'))
                    .replace('{{order_id}}', payment.orderId)
                    .replace('{{due_date}}', formatDate(payment.dueDate));
                if (await sendWhatsAppMessage(retailer.whatsappNumber, message)) {
                    await addNotificationLog('Payment Reminder', retailer.shopName, message, 'sent');
                    showToast(`Reminder for ${retailer.shopName} sent to server.`, 'info');
                }
            }
        }
        
        async function sendPaymentReminders() {
            const pending = appData.payments.filter(p => p.status === 'pending' || p.status === 'overdue');
            showToast(`Sending ${pending.length} reminders via server...`, 'info');
            for (const payment of pending) {
                await sendPaymentReminder(payment.id);
            }
        }

        async function sendOrderConfirmation(order) {
            const retailer = appData.retailers.find(r => r.id === order.retailerId);
            if (retailer) {
                 const deliveryDate = new Date(order.date);
                 deliveryDate.setDate(deliveryDate.getDate() + 3);
                 const message = appData.templates.order_confirmation
                    .replace('{{retailer_name}}', retailer.ownerName)
                    .replace('{{order_id}}', order.id)
                    .replace('{{amount}}', order.totalAmount.toLocaleString('en-IN'))
                    .replace('{{delivery_date}}', formatDate(deliveryDate.toISOString().split('T')[0]));
                if (await sendWhatsAppMessage(retailer.whatsappNumber, message)) {
                    await addNotificationLog('Order Confirmation', retailer.shopName, message, 'sent');
                }
            }
        }

        async function loadNotificationTemplates() {
            const templateType = document.getElementById('templateType');
            const messageTemplate = document.getElementById('messageTemplate');
            
            if (templateType && messageTemplate) {
                templateType.addEventListener('change', function() {
                    messageTemplate.value = appData.templates[this.value] || '';
                });
                messageTemplate.value = appData.templates[templateType.value] || '';
            }
        }

        async function loadNotificationLog() {
            const container = document.getElementById('notificationLog');
            if (!container) return;
            
            container.innerHTML = appData.notifications.map(notif => `
                <div class="border-bottom pb-2 mb-2">
                    <div class="d-flex justify-content-between">
                        <small class="fw-bold">${notif.type}</small>
                        <span class="badge ${getNotificationStatusClass(notif.status)}">${notif.status}</span>
                    </div>
                    <div class="small">To: <strong>${notif.retailer}</strong></div>
                    <div class="small text-muted fst-italic">"${notif.message}"</div>
                    <div class="small text-muted text-end">${notif.timestamp}</div>
                </div>
            `).join('') || '<p class="text-muted small text-center mt-3">No notifications yet</p>';
        }

        function loadReportStats() {
            const container = document.getElementById('reportStats');
            if (!container) return;

            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            const monthlyOrders = appData.orders.filter(order => {
                const orderDate = new Date(order.date);
                return orderDate.getMonth() === thisMonth && orderDate.getFullYear() === thisYear;
            });

            const monthlyRevenue = monthlyOrders.reduce((sum, order) => sum + order.totalAmount, 0);
            const pendingPayments = appData.payments.filter(p => p.status === 'pending').length;
            const overduePayments = appData.payments.filter(p => p.status === 'overdue').length;

            container.innerHTML = `
                <div class="row">
                    <div class="col-6 text-center border-end">
                        <h4>${monthlyOrders.length}</h4><small>This Month Orders</small>
                    </div>
                    <div class="col-6 text-center">
                        <h4>₹${monthlyRevenue.toLocaleString('en-IN')}</h4><small>This Month Revenue</small>
                    </div>
                </div><hr>
                <div class="row">
                    <div class="col-6 text-center border-end">
                        <h4 class="text-warning">${pendingPayments}</h4><small>Pending Payments</small>
                    </div>
                    <div class="col-6 text-center">
                        <h4 class="text-danger">${overduePayments}</h4><small>Overdue Payments</small>
                    </div>
                </div>
            `;
        }

        function generateReport() {
            showToast(`Generating report...`, 'info');
            setTimeout(() => showToast('Report downloaded successfully!', 'success'), 1500);
        }

        // Utility functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        function getStatusClass(status) {
            const classes = { pending: 'bg-warning', completed: 'bg-success', overdue: 'bg-danger', cancelled: 'bg-secondary' };
            return classes[status] || 'bg-secondary';
        }
        function getNotificationStatusClass(status) {
            const classes = { sent: 'bg-success text-white', failed: 'bg-danger text-white', test: 'bg-info text-dark' };
            return classes[status] || 'bg-secondary';
        }
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = `toast-${Date.now()}`;
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
                  <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                  </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);
            const bsToast = new bootstrap.Toast(toastElement, { delay: 5000 });
            bsToast.show();
            toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
        }

        function editRetailer(id) {
            const retailer = appData.retailers.find(r => r.id === id);
            if (retailer) {
                document.getElementById('retailerId').value = retailer.id;
                document.getElementById('shopName').value = retailer.shopName;
                document.getElementById('ownerName').value = retailer.ownerName;
                document.getElementById('phoneNumber').value = retailer.phoneNumber;
                document.getElementById('whatsappNumber').value = retailer.whatsappNumber;
                document.getElementById('address').value = retailer.address;
                document.getElementById('creditLimit').value = retailer.creditLimit;
                new bootstrap.Modal(document.getElementById('retailerModal')).show();
            }
        }

        async function deleteRetailer(id) {
            if (confirm('Are you sure?')) {
                appData.retailers = appData.retailers.filter(r => r.id !== id);
                if (await saveData()) { updateAllViews(); showToast('Retailer deleted.', 'success'); }
            }
        }
        
        function editProduct(id) {
            const product = appData.products.find(p => p.id === id);
            if (product) {
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productSKU').value = product.sku;
                document.getElementById('currentStock').value = product.currentStock;
                document.getElementById('minStock').value = product.minStock;
                document.getElementById('unitPrice').value = product.unitPrice;
                document.getElementById('productCategory').value = product.category;
                new bootstrap.Modal(document.getElementById('stockModal')).show();
            }
        }

        async function addStock(id) {
            const product = appData.products.find(p => p.id === id);
            const qty = parseInt(prompt(`Add stock for ${product.name}:`, "10"));
            if (product && qty > 0) {
                product.currentStock += qty;
                if (await saveData()) { updateAllViews(); showToast('Stock updated.', 'success'); }
            }
        }

    </script>
</body>
</html>